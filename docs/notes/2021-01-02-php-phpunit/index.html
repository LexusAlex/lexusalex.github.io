<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="yandex-verification" content="34b9532704688201" />

    <title>Тестирование кода в php · Алексей Шмелев</title>

    <meta name="description" content="Как начать тестировать код у себя в проекте">

    <meta property="og:type" content="website">
    <meta property="og:title" content="Тестирование кода в php">
    <meta property="og:description" content="Как начать тестировать код у себя в проекте">

    

    <link rel="stylesheet" href="/index.css">
    <!-- Yandex.Metrika counter --> <script type="text/javascript" > (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)}; m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)}) (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym"); ym(47811625, "init", { clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true, trackHash:true }); </script> <noscript><div><img src="https://mc.yandex.ru/watch/47811625" style="position:absolute; left:-9999px;" alt="" /></div></noscript> <!-- /Yandex.Metrika counter -->
</head>
<body>
    <div class="page">
        
<header class="header page__header">
    <div class="header__title">Алексей Шмелев</div>
    <ul class="navigation">
        <li class="navigation__item"><a class="link" href="/">Главная</a>
        <li class="navigation__item"><a class="link" href="/about/index.html">Обо мне</a>
    </ul>
</header>

<article class="article" itemtype="http://schema.org/BlogPosting" itemscope="">
    <header  class="article__header">
        <time datetime="2021-01-02T20:50:00.000Z" itemprop="datePublished">
            2 января 2021 г.
        </time>
        <h1 itemprop="name headline">Тестирование кода в php</h1>
    </header>

    <div class="content" itemprop="articleBody">
        <figure style="border: none">
            <img src="/assets/images/notes/1/main.png" alt=""  data-action="zoom">
        </figure>
        <p class="description">
            Как начать тестировать код у себя в проекте
        </p>
        <p>Все мы в разной степени начинаем с ручного тестирования своего кода — это не плохо,
но возникают ряд проблем.</p>
<h2>Проблемы ручного тестирования кода</h2>
<ul>
<li>Отсутствие повторяемости. Одни и те же действия по выявлению ошибок нужно делать многократно (писать <code>print_r</code>, <code>var_dump</code> снова и снова), при этом нельзя точно сказать, что было протестировано, а что нет;</li>
<li>Ручные тесты &quot;долгие&quot; - это значит что можно часами сидеть и не видеть ошибку;</li>
<li>Невнимательность, человеческий фактор, не все было проверенно. Что-то было упущено из вида;</li>
<li>Бесконечные правки. В одном месте поправили, сломалось в другом;</li>
<li>Приходится постоянно проверять, что результат выполняемой программы соответствует ожидаемому.</li>
<li>При ручных проверках и большом проекте проверить весь функционал просто невозможно.</li>
</ul>
<p>Справится с этими проблемами помогают автоматические тесты или как еще их называют unit тесты.</p>
<p>Тестирование — это процесс проверки одного элемента кода (например, отдельная функция или класс), в изоляции от остальной
части программы.</p>
<h2>Преимущества автоматических (unit) тестов</h2>
<ul>
<li>Отладку кода можно сразу вести из тестов, без надобности писать перенаправления, заглушки, <code>exit()</code>, <code>var_dump()</code> и пр.;</li>
<li>По тесту можно сразу понять как работает метод, функция, без лишних конструкций. (&quot;Живая документация по коду&quot;);</li>
<li>Помогают не допускать регрессии готового кода, то есть &quot;новый&quot; код не ломает существующий;</li>
<li>Приучают писать маленькие методы и чистые функции, а не пихать всю логику в один метод, который сложно тестировать и поддерживать;</li>
<li>Помогают в ходе написания теста понять, как писать менее связанный код;</li>
<li>Автоматическая проверка избавляет разработчика от монотонной ручной проверки всего кода приложения;</li>
<li>Разработка без страха. Править код становится комфортнее, мы уверены, что конкретная функция работает, а следовательно уверены за весь код;</li>
<li>При правильном написании тестов скорость разработки быстрее чем без них.</li>
<li>Запуск тестов - быстрая процедура позволяющая запускать их хоть после каждого изменения в коде.</li>
</ul>
<h2>Каким должен быть unit тест</h2>
<ul>
<li>Маленьким. Тест должен проверять только одно требование.</li>
<li>Легко читаемым. При взгляде на код теста должно быть понятно что происходит.</li>
<li>Повторяемым. При каждом запуске тест выдает одинаковый результат.</li>
<li>При написании теста, в тестируемую функции нужно подставлять результат.</li>
<li>Тест должен выполнятся в специальном тестовом окружении.</li>
<li>Проверять все возможные исходы.</li>
</ul>
<h2>Зависимости кода</h2>
<p>Часто результат работы метода зависит от внешних факторов и взаимодействует с другими классами и системами.</p>
<p>Например для выполнения своей задачи функции нужен доступ к базе данных или к файлу на диске.</p>
<p>Чтобы заменить базу данных или файл нужна некая заглушка или фейковый класс, который будет всегда возвращать
предсказуемый результат. Такие классы называют <strong>стабами</strong> от англ. <code>stub</code>. При попытке прочитать данные из
базы данных тесту возвращается готовый массив с данными, тем самым заменяя базу данных.</p>
<p>Еще один вид заглушек <strong>моки</strong> от англ. <code>mock</code>. Эти классы нужны чтобы, проверить что функция была вызвана с определенными
параметрами.</p>
<p>Стабы и моки вместе называют фейками (fakes).</p>
<p>Для создания классов-заглушек нужно создать интерфейс или абстрактный класс и наследовать его от заменяемого класса.</p>
<p>Написание тестов очень сильно зависит от вашей от архитектуры проекта и связанности кода. В проектах с легаси кодом
написание тестов может занять месяцы.</p>
<h2>Смысл тестирования. Пример 1</h2>
<p>Протестируем функцию <code>sum</code> без использования дополнительных библиотек.</p>
<p>Функция <code>sum</code> возвращает сумму переданного массива.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><span class="token keyword">function</span> sum <span class="token punctuation">(</span><span class="token keyword">array</span> <span class="token variable">$numbers</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> int <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$numbers</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">array_sum</span><span class="token punctuation">(</span><span class="token variable">$numbers</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><span class="token delimiter important">?></span></span></code></pre>
<p>Проверим результат написав два теста <code>testSumFive</code> и <code>testSumZero</code>.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><span class="token keyword">function</span> testSumFive <span class="token punctuation">(</span>int <span class="token variable">$sum</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> bool <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$sum</span> <span class="token operator">===</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> testSumZero <span class="token punctuation">(</span>int <span class="token variable">$sum</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> bool <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$sum</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token function">testSumFive</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><br><span class="token function">testSumFive</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span><br><span class="token function">testSumZero</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><br><span class="token delimiter important">?></span></span></code></pre>
<p>Тесты можно писать и так, но запускать и поддерживать их неудобно.</p>
<p>Для этих целей будем использовать специальный фреймворк для написания тестов <a href="https://phpunit.de">phpunit</a>.</p>
<h2>Версии phpunit</h2>
<p>Phpunit развивается без обратной совместимости со старыми версиями.
Версия phpunit напрямую зависит от версии php, которая установлена у вас на сервере.</p>
<p>В момент написания этой статьи (декабрь 2020) актуальными и поддерживаемыми являются версии phpunit 8 и 9.</p>
<p>Например если вы используете php 7.0, то будет использоваться версия phpunit 6 или phpunit 5.
Если ваша версия php 5.3, то phpunit 4. Composer автоматически установит одну из этих версий.</p>
<p><a href="https://phpunit.de/supported-versions.html">Поддерживаемые версии phpunit</a></p>
<blockquote>
<p>Важно учесть, то что если тесты написаны под phpunit 7, в phpunit версии 8 они могут просто
не запустится. При написании тестов придерживайтесь одной мажорной версии, тогда в будущем не будет проблем.</p>
</blockquote>
<p>Список текущих версий и их поддержку удобно смотреть на сайте <a href="https://packagist.org/packages/phpunit/phpunit">https://packagist.org/packages/phpunit/phpunit</a></p>
<h2>Установка composer</h2>
<p>Де-факто стандартным и предпочитаемым способом установки библиотек в php, является
установка через менеджер зависимостей <a href="https://getcomposer.org/">composer</a>.</p>
<p>Установить <code>composer</code> можно командой</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">curl</span> -sS https://getcomposer.org/installer <span class="token operator">|</span> php -- --install-dir<span class="token operator">=</span>/bin --filename<span class="token operator">=</span>composer --quiet</code></pre>
<h2>Установка phpunit</h2>
<p>Тесты нужно запускать локально в dev окружении разработчика поэтому ставим phpunit в секцию <code>require-dev</code></p>
<pre class="language-shell"><code class="language-shell"><span class="token function">composer</span> require --dev phpunit/phpunit</code></pre>
<p>После установки фреймворк добавиться в файл <code>composer.json</code></p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br><span class="token property">"require-dev"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"phpunit/phpunit"</span><span class="token operator">:</span> <span class="token string">"^9.4"</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>И станет доступна команда <code>./vendor/bin/phpunit</code>.</p>
<p>Но так запускать не удобно, поэтому добавим команду в <code>composer.json</code>
в секцию <code>scripts</code></p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"phpunit --colors=always"</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Запускаем так <code>composer test</code>.</p>
<blockquote>
<p>На боевом сервере для того убрать <code>phpunit</code> из автозагрузки
необходимо выполнить <code>composer update --no-dev</code> для запрета установки пакетов из секции <code>require-dev</code>.</p>
</blockquote>
<p>Я для большего удобства использую <code>Makefile</code> для запуска <code>phpunit</code>.</p>
<p>Об утилите <code>make</code> подробнее можно узнать из материалов:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=pK9mF5aK05Q">Утилита make: полезный универсальный инструмент программиста</a></li>
<li><a href="https://guides.hexlet.io/makefile-as-task-runner/">Что такое Makefile и как начать его использовать</a></li>
<li><a href="https://ru.makefile.site/">Руководство по современному Make</a></li>
</ul>
<p>Если в проекте не используется composer, есть также альтернативный способ установки phpunit.</p>
<p>Нужно скачать phar архив и запустить его из указанного места.</p>
<pre class="language-shell"><code class="language-shell"><span class="token comment"># скачать phar архив</span><br><span class="token function">wget</span> -O phpunit https://phar.phpunit.de/phpunit-9.phar<br><span class="token comment"># сделать фаил исполняемым</span><br><span class="token function">chmod</span> +x phpunit<br><span class="token comment"># запустить из указанного места</span><br>./phpunit</code></pre>
<p>Если phpunit необходим глобально для всей системы можно переместить файл в директорию со всеми скриптами
<code>sudo mv phpunit /usr/local/bin/phpunit</code>. После этого команда <code>phpunit</code> будет доступна глобально.</p>
<p>Проверка последней версии phpunit.</p>
<pre class="language-shell"><code class="language-shell">phpunit --check-version<br>PHPUnit <span class="token number">9.4</span>.3 by Sebastian Bergmann and contributors.<br>You are using the latest version of PHPUnit.</code></pre>
<h2>Соглашения по написанию тестов</h2>
<p>Не существует однозначных правил по написанию тестов, но есть общие рекомендации, которых желательно придерживаться</p>
<ul>
<li>Необязательно, но принято исходный код приложения размещать в каталоге <code>/src</code>, а тесты в каталоге <code>/tests</code>.</li>
<li>Тестовые классы следует наследовать от класса <code>PHPUnit\Framework\TestCase</code>.</li>
<li>Тестовый класс следует именовать с постфиксом <code>*Test</code> например <code>/tests/UserTest.php</code>.</li>
<li>Один класс проекта соответствует одному тестовому классу, но не всегда. Это зависит от связей между классами и архитектуры проекта.</li>
<li>Методы тестирования должны быть публичными и иметь префикс <code>test*</code> например <code>testLogin</code> или <code>testAdmin</code>.</li>
<li>В док блоке теста можно использовать аннотацию <code>@test</code>.</li>
<li>Каждый метод тестирования должен запускаться независимо от других, то есть должен быть изолирован.</li>
<li>Для проверок соответствия реального и ожидаемого результата используются функции утверждения <code>assert*()</code> например <code>assertTrue()</code>.</li>
<li>Лучше на начальном этапе ставить меньше проверок, только так можно понять какие проверки нужно добавить в будущем.</li>
<li>Можно придерживаться общего принципа написания тестов такого как &quot;Подготовка Действие Утверждение&quot;.</li>
</ul>
<h3>Примеры именования тестовых методов</h3>
<pre class="language-text"><code class="language-text">testLogMessage<br>testLogMessageWithEmptyMessage<br>testLogMessageWithEmptyMessageAndEmtyContext<br>testLogMessageWithInvalidContext</code></pre>
<h2>Как запускать</h2>
<p>Итак <code>phpunit</code> установлен, настало время запустить наши тесты.</p>
<p>Для запуска тестов необходимо указать директорию или название файлов которые необходимо запустить, например:</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">composer</span> phpunit tests<br><span class="token function">composer</span> phpunit tests/DummyTest<br><span class="token function">composer</span> phpunit tests/DummyTest.php</code></pre>
<p>Далее будет произведен поиск класса теста, затем будут выполнены тестовые методы этого класса.</p>
<p>Но по-файлово запускать неудобно, поэтому добавим конфигурацию.</p>
<h2>Конфигурация</h2>
<p>Создадим файл конфигурации <code>phpunit.xml</code> в корне проекта c настройками по умолчанию.</p>
<p>Проще всего это сделать выполнив команду.</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">composer</span> phpunit --generate-configuration</code></pre>
<p>Будет сгенерирован xml файл конфигурации:</p>
<pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phpunit</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span><br>         <span class="token attr-name"><span class="token namespace">xsi:</span>noNamespaceSchemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://schema.phpunit.de/9.4/phpunit.xsd<span class="token punctuation">"</span></span><br>         <span class="token attr-name">bootstrap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vendor/autoload.php<span class="token punctuation">"</span></span><br>         <span class="token attr-name">cacheResultFile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>var/cache/.phpunit.result.cache<span class="token punctuation">"</span></span><br>         <span class="token attr-name">executionOrder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>depends,defects<span class="token punctuation">"</span></span><br>         <span class="token attr-name">forceCoversAnnotation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><br>         <span class="token attr-name">beStrictAboutCoversAnnotation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><br>         <span class="token attr-name">beStrictAboutOutputDuringTests</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><br>         <span class="token attr-name">beStrictAboutTodoAnnotatedTests</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><br>         <span class="token attr-name">failOnRisky</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><br>         <span class="token attr-name">failOnWarning</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><br>         <span class="token attr-name">verbose</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>testsuites</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>testsuite</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>default<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span> <span class="token attr-name">suffix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Test.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>tests<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>testsuite</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>testsuites</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>coverage</span> <span class="token attr-name">cacheDirectory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>var/cache/.phpunit.code-coverage<span class="token punctuation">"</span></span> <span class="token attr-name">processUncoveredFiles</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span> <span class="token attr-name">suffix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>src<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>coverage</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phpunit</span><span class="token punctuation">></span></span></code></pre>
<p>Описание параметров можно найти в <a href="https://phpunit.readthedocs.io/en/9.3/configuration.html">документации</a></p>
<h2>Phpunit. Пример 2</h2>
<p>Теперь перепишем пример 1 с использованием phpunit. Для этого создадим класс приложения <code>/src/Application.php</code> с единственным методом <code>sum</code></p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">namespace</span> <span class="token package">Application</span><span class="token punctuation">;</span><br><br><span class="token keyword">class</span> <span class="token class-name">Application</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> sum <span class="token punctuation">(</span><span class="token keyword">array</span> <span class="token variable">$numbers</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> int <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$numbers</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token function">array_sum</span><span class="token punctuation">(</span><span class="token variable">$numbers</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Для большего удобства в директории <code>/tests</code> создадим абстрактный класс <code>/tests/AbstractTestCase.php</code> который наследуем от класса фреймворка <code>PHPUnit\Framework\TestCase</code> и
определим метод <code>setUp</code>, в нем создадим объект нашего приложения.</p>
<blockquote>
<p>Метод setUp будет запускаться каждый раз при выполнении тестового метода</p>
</blockquote>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">namespace</span> <span class="token package">Tests</span><span class="token punctuation">;</span><br><br><span class="token keyword">use</span> <span class="token package">Application<span class="token punctuation">\</span>Application</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token package">PHPUnit<span class="token punctuation">\</span>Framework<span class="token punctuation">\</span>TestCase</span><span class="token punctuation">;</span><br><br><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractTestCase</span> <span class="token keyword">extends</span> <span class="token class-name">TestCase</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">public</span> Application <span class="token variable">$application</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void<br>    <span class="token punctuation">{</span><br>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">application</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Теперь добавим непосредственного тестовый класс <code>/tests/ApplicationTest</code> который в свою очередь наследуем от <code>AbstractTestCase</code>,
где будут два тестовых метода с двумя утверждениями.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">namespace</span> <span class="token package">Tests</span><span class="token punctuation">;</span><br><br><span class="token keyword">class</span> <span class="token class-name">ApplicationTest</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTestCase</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> testSumFive <span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">application</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'сумма элементов массива не соответствует 5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> testSumZero <span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">application</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Запускаем тесты</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">composer</span> <span class="token builtin class-name">test</span><br><br>PHPUnit <span class="token number">9.4</span>.3 by Sebastian Bergmann and contributors.<br><br>Runtime:       PHP <span class="token number">7.4</span>.12<br>Configuration: /template/phpunit.xml<br><br><span class="token punctuation">..</span>                                                                  <span class="token number">2</span> / <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span><br><br>Time: 00:00.002, Memory: <span class="token number">6.00</span> MB<br><br>OK <span class="token punctuation">(</span><span class="token number">2</span> tests, <span class="token number">2</span> assertions<span class="token punctuation">)</span></code></pre>
<p>Две точки в выводе означают что два наших теста успешно прошли.</p>
<p>Теперь представим что наша функция <code>sum</code> работает неправильно.</p>
<pre class="language-shell"><code class="language-shell">$ <span class="token function">composer</span> <span class="token builtin class-name">test</span><br><br>PHPUnit <span class="token number">9.4</span>.3 by Sebastian Bergmann and contributors.<br><br>Runtime:       PHP <span class="token number">7.4</span>.12<br>Configuration: /template/phpunit.xml<br><br>.F                                                                  <span class="token number">2</span> / <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span><br><br>Time: 00:00.003, Memory: <span class="token number">6.00</span> MB<br><br>There was <span class="token number">1</span> failure:<br><br><span class="token number">1</span><span class="token punctuation">)</span> Tests<span class="token punctuation">\</span>ApplicationTest::testSumFive<br>сумма элементов массива не соответствует <span class="token number">5</span><br>Failed asserting that <span class="token number">25</span> matches expected <span class="token number">5</span>.<br><br>/template/tests/ApplicationTest.php:11<br><br>FAILURES<span class="token operator">!</span><br>Tests: <span class="token number">2</span>, Assertions: <span class="token number">2</span>, Failures: <span class="token number">1</span>.</code></pre>
<p>Получаем ошибку (буква <code>F</code>, значит второй тест), где прекрасно видно в каком файле и какой тест упал и что конкретно произошло.</p>
<h3>Вывод тестов</h3>
<p>Теперь разберем вывод тестов, какие обозначения могут быть.</p>
<ul>
<li><code>W</code> - В классе не найдены тестовые методы.</li>
</ul>
<pre class="language-shell"><code class="language-shell">WW                                                                  <span class="token number">2</span> / <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span><br>Warning<br>No tests found <span class="token keyword">in</span> class <span class="token string">"Tests\Application2Test"</span><span class="token builtin class-name">.</span><br>WARNINGS<span class="token operator">!</span><br>Tests: <span class="token number">2</span>, Assertions: <span class="token number">0</span>, Warnings: <span class="token number">2</span>.</code></pre>
<ul>
<li><code>.</code> - Тест пройден успешно</li>
</ul>
<pre class="language-shell"><code class="language-shell"><span class="token punctuation">..</span>                                                                  <span class="token number">2</span> / <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span><br>OK <span class="token punctuation">(</span><span class="token number">2</span> tests, <span class="token number">2</span> assertions<span class="token punctuation">)</span></code></pre>
<ul>
<li><code>F</code> - Тест не пройден, выводится информация почему тест не прошел.</li>
</ul>
<pre class="language-shell"><code class="language-shell">.F                                                                  <span class="token number">2</span> / <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span><br><span class="token number">1</span><span class="token punctuation">)</span> Tests<span class="token punctuation">\</span>ApplicationTest::testSumFive<br>сумма элементов массива не соответствует <span class="token number">5</span><br>Failed asserting that <span class="token number">25</span> matches expected <span class="token number">5</span>.<br><br>/template/tests/ApplicationTest.php:11<br><br>FAILURES<span class="token operator">!</span><br>Tests: <span class="token number">2</span>, Assertions: <span class="token number">2</span>, Failures: <span class="token number">1</span>.</code></pre>
<ul>
<li><code>R</code> - Тест не содержит утверждений (функции asert...) и будет пропущен.</li>
</ul>
<pre class="language-shell"><code class="language-shell">RR                                                                  <span class="token number">2</span> / <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span><br><span class="token number">1</span><span class="token punctuation">)</span> Tests<span class="token punctuation">\</span>ApplicationTest::testSumZero<br>This <span class="token builtin class-name">test</span> did not perform any assertions<br><br>/template/tests/ApplicationTest.php:14<br><br><span class="token number">2</span><span class="token punctuation">)</span> Tests<span class="token punctuation">\</span>ApplicationTest::testSumFive<br>This <span class="token builtin class-name">test</span> did not perform any assertions<br><br>/template/tests/ApplicationTest.php:9<br><br>OK, but incomplete, skipped, or risky tests<span class="token operator">!</span><br>Tests: <span class="token number">2</span>, Assertions: <span class="token number">0</span>, Risky: <span class="token number">2</span>.</code></pre>
<ul>
<li><code>E</code> - Произошла синтаксическая ошибка во время запуска теста. При этом подробно указано в каком файле это произошло.</li>
</ul>
<pre class="language-shell"><code class="language-shell">EE                                                                  <span class="token number">2</span> / <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span><br><span class="token number">1</span><span class="token punctuation">)</span> Tests<span class="token punctuation">\</span>ApplicationTest::testSumFive<br>ParseError: syntax error, unexpected <span class="token string">'3232'</span> <span class="token punctuation">(</span>T_LNUMBER<span class="token punctuation">)</span><br><br>/template/src/Application.php:17<br>/template/tests/AbstractTestCase.php:16<br><br><span class="token number">2</span><span class="token punctuation">)</span> Tests<span class="token punctuation">\</span>ApplicationTest::testSumZero<br>ParseError: syntax error, unexpected <span class="token string">'3232'</span> <span class="token punctuation">(</span>T_LNUMBER<span class="token punctuation">)</span><br><br>/template/src/Application.php:17<br>/template/tests/AbstractTestCase.php:16<br><br>ERRORS<span class="token operator">!</span><br>Tests: <span class="token number">2</span>, Assertions: <span class="token number">0</span>, Errors: <span class="token number">2</span>.</code></pre>
<ul>
<li><code>I</code> - Не полный или незавершенный тест. Если тест не дописан необходимо вызвать метод <code>$this-&gt;markTestIncomplete('Этот тест ещё не реализован.');</code></li>
</ul>
<pre class="language-shell"><code class="language-shell">.I                                                                  <span class="token number">2</span> / <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span><br><br><span class="token number">1</span><span class="token punctuation">)</span> Tests<span class="token punctuation">\</span>ApplicationTest::testSumFive<br>Этот тест ещё не реализован.<br><br>/template/tests/ApplicationTest.php:13<br><br>OK, but incomplete, skipped, or risky tests<span class="token operator">!</span><br>Tests: <span class="token number">2</span>, Assertions: <span class="token number">1</span>, Incomplete: <span class="token number">1</span>.</code></pre>
<ul>
<li><code>S</code> - Тест был отмечен как пропущенный. Необходимо вызвать метод <code>$this-&gt;markTestSkipped('Этот тест пропущен');</code></li>
</ul>
<pre class="language-shell"><code class="language-shell">.S                                                                  <span class="token number">2</span> / <span class="token number">2</span> <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span><br><br><span class="token number">1</span><span class="token punctuation">)</span> Tests<span class="token punctuation">\</span>ApplicationTest::testSumFive<br>Этот тест пропущен<br><br>/template/tests/ApplicationTest.php:13<br><br>OK, but incomplete, skipped, or risky tests<span class="token operator">!</span><br>Tests: <span class="token number">2</span>, Assertions: <span class="token number">2</span>, Skipped: <span class="token number">1</span>.</code></pre>
<h2>Утверждения</h2>
<p>Для проверки значений как мы видели выше в phpunit используются <a href="https://phpunit.readthedocs.io/en/latest/assertions.html#">утверждения</a></p>
<p>Самые часто используемые из них:</p>
<pre class="language-php"><code class="language-php"><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertContains</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// содержит массив указанное значение</span><br><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertStringContainsString</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'тест'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'нетест'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// содержит строка подстроку</span><br><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// количество элементов в массиве</span><br><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertEmpty</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'foo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// является ли значение пустым</span><br><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// эквивалентность значений</span><br><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// логическая операция</span><br><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertGreaterThan</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// больше чем</span><br><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertIsArray</span><span class="token punctuation">(</span><span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// значение должно быть массивом</span><br><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertObjectHasAttribute</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'foo'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">stdClass</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// содержит ли класс атрибут</span></code></pre>
<blockquote>
<p>Практически все методы утверждения содержат противоположные методы
Например assertContains() и assertNotContains()</p>
</blockquote>
<h2>Провайдеры данных</h2>
<p>Бывают ситуации, когда нужно проверить сразу несколько значений. Для этих целей существуют дата провайдеры.</p>
<p>Дата провайдер - это метод или методы, который возвращает набор данных для проверки в тесте.</p>
<p>Напишем тест, например для проверки по регулярному выражению.</p>
<h2>Провайдеры данных. Пример 3</h2>
<p>Создадим метод <code>Values()</code>, который будет использоваться в качестве провайдера данных и тестовый метод <code>testValidValues()</code>, в котором укажем аннотацию <code>@dataProvider</code>.</p>
<p>Он будет принимать произвольное количество аргументов.</p>
<p>Для каждого элемента массива из метода <code>Values()</code> будет вызываться метод <code>testValidValues()</code>.</p>
<p>В массиве первый элемент проверяемое значение регулярного выражения, второй элемент результат который должна выдать функция
<code>preg_match</code>.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">namespace</span> <span class="token package">Tests</span><span class="token punctuation">;</span><br><br><span class="token keyword">class</span> <span class="token class-name">ApplicationTest</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTestCase</span><br><span class="token punctuation">{</span><br>    <span class="token comment">/**<br>     * @param $value<br>     * @param $expected<br>     * @dataProvider Values<br>     */</span><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">testValidValues</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$expected</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br><br>        <span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'/^[a-f0-9_-]{2,6}$/i'</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token variable">$expected</span><span class="token punctuation">,</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">Values</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token punctuation">[</span><br>            <span class="token punctuation">[</span><span class="token single-quoted-string string">'ab12'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token punctuation">[</span><span class="token single-quoted-string string">''</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token punctuation">[</span><span class="token single-quoted-string string">'--_09f'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token punctuation">[</span><span class="token single-quoted-string string">'1'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token punctuation">[</span><span class="token single-quoted-string string">'123456789'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token punctuation">[</span><span class="token single-quoted-string string">'русские буквы'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token punctuation">[</span><span class="token single-quoted-string string">'aBcDeF'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>        <span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Запускаем тесты</p>
<pre class="language-shell"><code class="language-shell"> phpunit<br>PHPUnit <span class="token number">9.4</span>.3 by Sebastian Bergmann and contributors.<br><br>Runtime:       PHP <span class="token number">7.4</span>.12<br>Configuration: /template/phpunit.xml<br><br><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.                                                             <span class="token number">7</span> / <span class="token number">7</span> <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span><br><br>Time: 00:00.003, Memory: <span class="token number">6.00</span> MB<br><br>OK <span class="token punctuation">(</span><span class="token number">7</span> tests, <span class="token number">7</span> assertions<span class="token punctuation">)</span></code></pre>
<p>Как видим были выполнены 7 проверок, вместо того чтобы писать 7 тестовых методов.</p>
<h2>Зависимые тесты. Пример 4</h2>
<p>PhpUnit позволяет писать зависимые тесты друг от друга. Посмотрим на пример.</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">namespace</span> <span class="token package">Tests</span><span class="token punctuation">;</span><br><br><span class="token keyword">class</span> <span class="token class-name">ArrayTest</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTestCase</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">testOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token variable">$array</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span> <span class="token variable">$array</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">/**<br>     * @param array $array<br>     * @depends testTwo<br>     */</span><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">testThree</span><span class="token punctuation">(</span><span class="token keyword">array</span> <span class="token variable">$array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span><br>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertCount</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">/**<br>     * @param array $array<br>     * @depends testOne<br>     * @return int[]<br>     */</span><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">testTwo</span><span class="token punctuation">(</span><span class="token keyword">array</span> <span class="token variable">$array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token variable">$array</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertCount</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span> <span class="token variable">$array</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Метод <code>testOne</code> возвращает фикстуру <code>array</code> в данном случае это пустой массив.</p>
<p>Далее выполняется тест <code>testTwo</code> так как, он зависит от <code>testOne</code> с аннотацией <code>@depends testOne</code> и тоже возвращает фикстуру.
Последним будет выполнен зависимый тест <code>testThree</code>, который работает с возвращенной ранее фикстурой.</p>
<h2>Фикстуры</h2>
<p>Одной из наиболее трудозатратных частей при написании тестов является написание кода для настройки тестового окружения.</p>
<p>Для этого нужно создать некий объект эмулирующий объект проверки до выполнения теста, и возврат его в исходное состояние после выполнения теста.</p>
<p>Это состояние называется фикстурой теста.</p>
<p>В примере 4 мы посмотрели как запускать зависимые тесты путем возврата фикстуры <code>array</code>.
В данном случае — это был пустой массив, но в реальности все может быть намного сложнее. Перепишем этот пример следующем образом.</p>
<h2>setUp и tearDown. Пример 5</h2>
<blockquote>
<p>Встроенные методы setUp(): void и tearDown(): void вызываются по одному разу при каждом выполнении тестового метода</p>
</blockquote>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">namespace</span> <span class="token package">Tests</span><span class="token punctuation">;</span><br><br><span class="token keyword">class</span> <span class="token class-name">ArrayTest</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTestCase</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">protected</span> <span class="token keyword">array</span> <span class="token variable">$array</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void<br>    <span class="token punctuation">{</span><br>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token keyword">array</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>        <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TODO: Change the autogenerated stub</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void<br>    <span class="token punctuation">{</span><br>        <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token keyword">array</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TODO: Change the autogenerated stub</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">testOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token keyword">array</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">testTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token keyword">array</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertCount</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token keyword">array</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br><span class="token punctuation">}</span><br></code></pre>
<p>Помимо <code>setUp()</code> и <code>tearDown()</code> существуют так же и другие встроенные методы, которые можно использовать в зависимости от ситуации.</p>
<pre class="language-text"><code class="language-text">setUpBeforeClass() // вызывается перед запуском первого теста текущего тестового класса<br>tearDownAfterClass() // вызывается после выполнения последнего теста текущего тестового класса<br>assertPreConditions() // перед выполнением тестового метода<br>assertPostConditions() // после выполнения тестового метода<br>onNotSuccessfulTest() // Будет выполнен если тест был провален</code></pre>
<p>Например сли у нас в классе два тестовых метода <code>testOne()</code> и <code>testTwo()</code>, то при наличии всех выше написанных методов порядок выполнения будет таким:</p>
<ul>
<li>setUpBeforeClass()</li>
<li>setUp()</li>
<li>assertPreConditions()</li>
<li>testOne()</li>
<li>assertPostConditions()</li>
<li>tearDown()</li>
<li>setUp()</li>
<li>assertPreConditions()</li>
<li>testTwo()</li>
<li>assertPostConditions()</li>
<li>tearDown()</li>
<li>tearDownAfterClass()</li>
</ul>
<blockquote>
<p>Если тест не пройдет, то метод <code>assertPostConditions()</code> вызван не будет, впоследствии будет вызван метод <code>onNotSuccessfulTest</code></p>
</blockquote>
<h2>Классы-заглушки</h2>
<p>При тестировании больших систем не всегда представляется возможным использовать реальный компонент приложения.</p>
<p>PhpUnit позволяет заменить зависимый компонент классом-заглушкой, который должен имитировать поведение реального
компонента приложения.</p>
<h3>Имитация реального приложения. Пример 6</h3>
<pre class="language-php"><code class="language-php"><br><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><span class="token comment">// tests/fakes/FakeClass.php</span><br><br><span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">namespace</span> <span class="token package">Tests<span class="token punctuation">\</span>fakes</span><span class="token punctuation">;</span><br><br><span class="token keyword">class</span> <span class="token class-name">FakeClass</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">fake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token single-quoted-string string">'Это заглушка для реального метода'</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// tests/StubTest.php</span><br><br><span class="token keyword">namespace</span> <span class="token package">Tests</span><span class="token punctuation">;</span><br><br><span class="token keyword">use</span> <span class="token package">Tests<span class="token punctuation">\</span>fakes<span class="token punctuation">\</span>FakeClass</span><span class="token punctuation">;</span><br><br><span class="token keyword">class</span> <span class="token class-name">StubTest</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTestCase</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">testStub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$stub</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">createMock</span><span class="token punctuation">(</span>FakeClass<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$stub</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">method</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'fake'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">willReturn</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assertSame</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'test'</span><span class="token punctuation">,</span> <span class="token variable">$stub</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>В реальности для написания класса-заглушки может понадобится не одна неделя, все зависит от архитектуры вашего приложения.</p>
<p>Подробнее об <a href="https://phpunit.readthedocs.io/en/9.5/test-doubles.html">моках и стабах</a></p>
<h2>Покрытие кода</h2>
<p>Каждый метод (функция) должны быть покрыты тестами для всех возможных вариантов выполнения метода (функции).</p>
<p>PhpUnit позволяет формировать отчет о покрытии кода тестами в различных форматах.</p>
<blockquote>
<blockquote>
<p>Для формировании отчета о покрытии кода тестами на сервере должен быть установлен расширение XDEBUG</p>
</blockquote>
</blockquote>
<p>Для создания анализа покрытие нужно выполнить команду</p>
<pre class="language-shell"><code class="language-shell"><span class="token assign-left variable">XDEBUG_MODE</span><span class="token operator">=</span>coverage <span class="token function">composer</span> phpunit --coverage-html var/test/coverage</code></pre>
<p>В данном случае в директории <code>var/test/coverage</code> будут созданы html файлы с отчетом, где отображено покрытие кода.</p>
<figure>
  <img src="/assets/images/notes/5/phpunit-coverage.png" alt="Phpunit - покрытие кода"  data-action="zoom">
</figure>
<h2>Полезные Ссылки</h2>
<ul>
<li><a href="https://phpunit.de">Официальный сайт</a></li>
<li><a href="https://phpunit.readthedocs.io/en/9.5/">Документация</a></li>
<li><a href="https://ru.hexlet.io/blog/posts/how-to-test-code">Статья про тестирование</a></li>
<li><a href="https://gist.github.com/codedokode/a455bde7d0748c0a351a">Еще статья про тестирвоание</a></li>
</ul>

    </div>

    <div id="disqus_thread"></div>
    <script>
        /**
         *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
         *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
        /*
        var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        */
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://lexusalex-ru.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</article>

<footer>
    <p>
        Работает на <a href="https://www.11ty.dev/">Eleventy</a> - 2020
    </p>
</footer>
    </div>
    <script src="/assets/js/medium-zoom.min.js"></script>
    <script src="/assets/js/main.js"></script>
    <script id="dsq-count-scr" src="//lexusalex-ru.disqus.com/count.js" async></script>
</body>
</html> 