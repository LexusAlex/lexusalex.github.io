--- 
layout: post 
title: Php Функции 
permalink: php-functions
tags: php
--- 

Функции очень важный механизм в языках программирования, нужно понимать и уметь с ними работать.

##Детерминированные функции

Рассмотрим примеры:

~~~php
<?php
// результат функции полностью зависит от входных параметров, что поддается контролю и упрощает тестирование
function test($a, $b, $c)
{
    return ($a + $b + $c);
}

// результатом функции является случайное число, его невозможно предугадать
function test1($a)
{
    return random_int(10,20) + $a;
}

// функция обращается к суперглобальному массиву $_SERVER. Значение ключа массива на другом сервере может быть другим
function test2()
{
    return $_SERVER['SERVER_SOFTWARE'];
}
?>
~~~

Функция `test()` является детерминированной, так как ведет себя предсказуемо, результат полностью зависит от входных параметров.
Напротив `test1()` и `test2()`, такой функцией не является, так как результат всегда разный, ее нельзя протестировать.

По возможности пишити детерминированные функции как `test()`

##Функции с побочными эффектами

Посмотрим на примеры:

~~~php
<?php
// создаем и пишем в фаил
function test3()
{
    file_put_contents('file.txt', 'Текст для записи', FILE_APPEND);
}

// функция с побочным эффектом если выводит текст на печать
function test4()
{
    echo 'text';
}
?>
~~~

Функция с побочным эффектом - это функция которая обращаеться к глобальным переменным, пишет и читает из файла, работает
с базой данных.

Нужно уметь отделять побочные эффекты от чистого кода.

Типичная задача веб - приложения.
1. Принять пользовательский запрос
2. Отдать пользователю ответ

Между первым и вторым шагом происходит основная работа, а побочные эффекты можно вынести в начало и в конец работы приложения, то есть
изолировать и отделять чистый код от нечистого.

Если функция детерминированная и без побочных эффектов то он называется чистой, чего и нужно стремиться

##Функция команда

~~~php
<?php
// функция занимается вставкой данных в базу данных
function test5()
{
    $mariadb = new PDO('mysql:dbname=root;host=mariadb;port=3306', 'root', 'root', [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => false,
    ]);

    $stm = $mariadb->prepare('INSERT INTO test (text) VALUES (:text)');
    return $stm->execute([':text' => 'текст1']);
}
?>
~~~

Какие проблемы сразу видны в этой функции: 
-   Функция с побочными эффектами (обращение к базе данных)
-   Учетные данные храняться прямо в функции

Выделим код соединения с базой в отдельную функцию

~~~php
<?php

function connect($data)
{
    return new PDO("mysql:dbname=$data[dbname];host=$data[host];port=$data[port]", $data['login'], $data['pass'], [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => false,
    ]);

}
?>
~~~


Структура пары


Рассмотрим, что себя представляют функции в php

---
## Что мы знаем о функциях в php

1. Функции обычно определяют заранее, но это не обязательно, интерпретатор сначала определит все функции в файле, а потом начнет исполнение скрипта
    ~~~php
    <?php
        echo test(); // будет выведено 'test' несмотря на то что декларация функции идет ниже
    
        function test() {
            return 'test';
        }
    ?>
    ~~~
1. Функции можно вкладывать друг в друга, но вложенные функции можно вызвать только в том случае если вызваны родительские функции
    ~~~php
    <?php
        //если вызвать test2() без вызовать test() то получим ошибку Call to undefined function test2()
        test();
        test2();
        echo test3(); // будет выведено 'function test 3'
    
        function test() {
            function test2() {
                function test3() {
                    return 'function test 3';
                }
            }
        }
    ?>
    ~~~
1. Все функции имеют глобальную область видимости, могут быть вызваны в любом месте (к вопросу о рекурсии)
1. Не поддеживается переопределение и удаление функции
    ~~~php
    <?php
        function test() {
            return 'test';
        }
    
        function test() { // при такой декларации получим ошибку что такая функция уже есть Cannot redeclare test() (previously declared in
            return 'test2';
        }
    
    ?>
    ~~~
1. Переполнение стека рекурсии является программной ошибкой
1. Передача аргументов в функцию по значению, это значит что значения аргументов изолированы внутри функции. В качестве примера посмотрим на вызов функции
    ~~~php
    <?php
        function text($string) {
            $string .= ' (last text)';
        }
        $str = '(first text)';
        text($str);
        $str .= ' (some text)';
        text($str);
        echo $str; //(first text) (some text) 
    ?>
    ~~~
    Не смотря на то, что функция была вызвана 2 раза, внутренняя переменная `$string` не фигурирует в ответе
    
    TODO ---
    

## Детерминированность функции
  
Функция называется детерминированной если она всегда для одних и тех же наборов входных данных возвращает один и тот же результат

Как пример функции `rand();` и `date('Y');` называют не детерминированными, так как rand всегда возвращает случайное число, а
date, возвратит текущий год, а он тоже меняется.

Детерминированные функции, напротив, ведут себя предсказуемо. Для одних и тех же входных данных, они всегда выдают один и тот же результат.
Это важно так как это дает предсказуемость возвращаемых значений функции, и количество состояний которые нужно обрабатывать.

Понятие детерминированность важно в тех вопросах где важно состояние, например задачи связанные с настройкой серверов должна быть детерминированной
Так же функция становиться не детерминированной если она обращается к внешним данным, глобальными переменным, потому что в процессе работы программы они могут изменится, и соответственно изменится вывод функции

По возможности создавайте такие функции которые зависят только от своих аргументов.

## Побочный эффект функции

Побочным эффектом называют любые действия которые изменяют среду выполнения такие как изменение файла, отправка и прием данных по сети, обращение к глобальным переменным
Наличие побочных эффектов приводит сложносям при разработке, трудности в тестировании и отладке.

Такие операторы как инкремент и декремент являютсяч операторами с побочными эффектами, они согут приводить к сложноотловимым ошибкам


Их крайне просто тестировать. Достаточно передать на вход функции нужные параметры и посмотреть ожидаемый выход.
Их безопасно запускать повторно, что особенно актуально в асинхронном коде или в случае многопоточного кода.
Их легко комбинировать получая новое поведение без необходимости переписывать программу.

В программах побочные эффекты нужно изолировать что основная часть кода была чистой

Здесь необходимо отделять чистый код в функции
  
  
  
    Детерминированность
    Побочные эффекты
    Splat operator
    Объекты первого рода
    Функции высшего порядка (map/filter/reduce)
    Функциональное программирование

