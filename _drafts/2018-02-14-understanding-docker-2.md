---
layout: post
title:  Понимая Docker (продолжение)
date:   2018-02-14
author: Алексей Шмелев
categories: docker
comments: true
cover:  "/assets/docker/docker.jpeg"
---

В предыдущий [раз](https://lexusalex.github.io/docker/2018/01/14/understanding-docker.html) рассмотрели базовое использование Докера.

Сегодня продолжаем разбираться , так же рассмотрим как создать свой образ и собрать проект.

Итак что мы имеем:

- Образ - файловая система
- Контейнер - процесс в файловой системе образа, полностью изолированный

Мы можем собрать контейнер из образа и радоваться жизни.
К примеру скачать и запустить nginx можно одной командой

~~~bash
docker run -d -p 8080:80 nginx
~~~


После этого nginx будет работать в фоне, доступ к нему можно получить набрав 127.0.0.1:8080 в браузере

или запустить bash внутри контейнера, можно запустить совершенно любую команду

~~~bash
docker run -it ubuntu bash
~~~

Также нужно отметить такую вещь как проброс портов. Исходя из настроек образа nginx, он слушает 80 порт
При запуске такой команды ```docker run -d -p 8080:80 nginx``` мы пробрасываем порт 8080 наружу, теперь на всех компьютерах сети есть доступ к контейнеру по ip компьютера.
На самом хосте 127.0.0.1:8080, с других 192.168.0.105:8080 , таким образом можно не поднимая веб сервер запустить любое приложение внутри сети.
Если нужно ограничить доступ с других машин в сети то нужно указать явно ip ```docker run -p -d 127.0.0.1:8080:80 nginx``` . Можно указать неограниченное количество портов.

Тоже часто используемая возможность докера это монтирование папки хоста к файловой системе контейнера.
Например у нас есть база данных, данные внутри контейнера лучше не хранить, поэтому выведем их на хост машину

~~~bash
docker run --name db -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -v /home/alex/data/p1:/var/lib/mysql -d mysql:5.7 
~~~
В примере выше мы вынесли данные базы данных на хост машину, даже если мы удалим контейнер, мы не потеряем данные никаким образом, также бывает удобно просматривать лог веб сервера у себя на машине, для этого можно добавить ro в конце пути

~~~bash
docker run --name db -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -v /home/docker/www:/usr/share/nginx/html:ro
~~~


Собирать контейнер можно для множества задач, для тестирования, отладки.

### Dockerfile

Как выяснили Докер - это отличный инструмент для экспериментов и работы.Попробуем создать свой собственный образ

Для этого есть Dockerfile, это описание того что нужно получить то есть по сути скрипт для создания образа.

То есть нужно написать один раз команды каким должен быть контейнер и впоследствии воссоздавать окружение на любом компьютере, где установлен докер.
 
Под каждый проект нужно готовить свой Dockerfile так как требования разные.

Скачаем официальный образ apache php
~~~bash
docker pull php:7.2.1-apache-stretch
~~~

Создадим теперь свой образ для запуска проекта на yii2, и запустим стандарное приложение.

Для примера запустим пустую болванку приложение на yii2 назовем его scratch-yii2 для последующего быстрого разворачивания проектов. Структура выгдядит так:

~~~bash

assets
composer.json
composer.lock
config
controllers
docker
Dockerfile
init.sh
requirements.php
runtime
start.sh
stop.sh
vendor
views
web
yii

~~~

Dockerfile выглядит так, здесь мы собираем образ

~~~
FROM php:7.2.1-apache-stretch

MAINTAINER alex

RUN apt-get update && \
    apt-get -y install curl libxml2-dev git zlib1g-dev unzip && \
    apt-get clean && \
	rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

RUN docker-php-ext-install \
        intl \
        mbstring \
        pdo_mysql \
		zip


RUN curl -sS https://getcomposer.org/installer | php -- \
        --filename=composer.phar \
        --install-dir=/usr/local/bin && \
/usr/local/bin/composer.phar clear-cache

COPY docker/000-default.conf /etc/apache2/sites-available/
~~~
В директории docker храним конфигурационные файлы для сервера и данные mysql

~~~bash
000-default.conf
mysql-data
~~~

Скрипт init.sh
 ~~~bash

# !/bin/bash

#собираем образ

docker build --tag lexusalex:web .

#запускаем mysql контейнер

docker run --name db -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -v "$PWD"/docker/mysql-data:/var/lib/mysql -d mysql:5.7

docker exec -i -t db mysql -proot -e "CREATE DATABASE yii2 DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;"


#запускаем контейнер из образа
docker run --name web --link db -p 80:80 -d -v "$PWD":/var/www/html lexusalex:web


#скачиваем зависимости

docker exec -i -t web /usr/local/bin/composer.phar update

 ~~~
Сделал еще пару скриптов для запуска и остановки контейнеров. Также можно написать скрипт для запуска миграций.

Для запуска проекта нужно сделать следующее:

- Установить докер
- Клонировать репозиторий
- запустить фаил ./init.sh

Под капотом этих шагов происходит следующее, идем по файлу init.sh

1. команда docker build собирает образ для этого в корне парсится Dockerfile, в нем выполняется FROM php:7.2.1-apache-stretch тем самым скачивается базовый образ на основе которого нам делать свой
2. Набор команд RUN выполяняют все что мы там напишем внутри образа, в данном случае, скачаем неоходимые пакеты, расширения php, composer, скопируем в образ конфиг apache
3. Теперь можно тоже самое сделать и для mysql но нас все устраивает что там есть из коробки, команда docker run запускает контейнер
4. Командой docker exec зайдем внутрь контейнера и создадим базу, кстати здесь можно так же загрузить дамп
5. Теперь запускаем контейнер нашего веб сервера линкуя его с уже запущенным контейнером mysql командой docker run
6. Скачаем зависимости composer

У меня этот процесс занял 8 минут, согласитесь не много.

Преимуществом является то , что для запуска приложения не нужно ставить тонны пакетов, докер делает это все в изолированном окружении.
Пример: Над большим проектом работает несколько человек, приходит новый сотрудник и два клика разворачивает и запускает проект и начинает работать. Просто прекрасно.
Без докера для того чтобы запустить проект пришлось бы потратить несколько часов чтобы развернуть у себя локально. а если нужно подготовить 50 рабочих мест...уже начинается головная боль.
Теперь даже важно какая у тебя ОС, докер доступен даже под windows.

Удобно так же, менять составные части нашей экосистемы. Изменились требования хотим протестировать новую версию php, нет ничего проще пересобрать контейнер, хотим вместо mysql попробовать posgresql, так же скачать новый образ слинковать с контейнером web.
Вышла новая версия php, скачали, пересобрали.Готово.

То что я выше описал не претендует на инструкцию по использованию, так как у любой технологии есть свои нюансы и способы работы в которых нужно уметь разбираться.

В следующий раз подробнее поговорим о директивах докерфайла и конечно же нужно попробовать плюшку в виде docker-compose