--- 
layout: post 
title: Тестирование кода. Использвание phpunit
permalink: test-code-phpunit
tags: testCode php
comments: true

--- 

Наши приложения, как правило состоят из множества зависимостей и модулей, которые связаны между собой.
С ростом приложения, проверки после изменений в коде становиться делать все сложнее. 
Пожалуй самый надежный способ проверить все, что уже работает и не сломалось ли чего - это автоматические тесты. 
Они есть во многих языках в том числе и в php. В мире php для этого используют
фреймворк для тестирования [phpunit](https://phpunit.de/)

### Установка phpunit

Существуют несколько версий phpunit, какую из них устанавливать зависит от версии php.
[Текущая поддержка версий phpunit](https://phpunit.de/supported-versions.html)

Мы будем использовать версию PHPUnit 7, [подробнее об установке](https://phpunit.de/getting-started/phpunit-7.html)

Установить phpunit можно тремя способами:
1. Скачать phar архив
    ~~~bash
    # скачать архив
    wget -O phpunit https://phar.phpunit.de/phpunit-7.phar
    # сделать фаил исполняемым
    chmod +x phpunit
    # запустить из указанного места
    ./phpunit
    ~~~
    можно установить глобально для всей системы переместив файл командой `sudo mv phpunit /usr/local/bin/phpunit`
    теперь команда `phpunit` будет доступна глобально
2. Используя composer, этот вариант предпочтительней
   ~~~bash
   # добавить зависимость в composer.json
   composer require --dev phpunit/phpunit ^7
   # запустить
   ./vendor/bin/phpunit
   ~~~  
3. Используя пакетный менеджер операционной системы
   ~~~bash
   sudo apt-get install phpunit
   ~~~ 
   будут установлены все зависимости и после этого phpunit будет доступен глобально


### Соглашения

Нет однозначных подходов по организации тестов, но есть наиболее подходящие и устоявшиеся практики:

- Принято исходный код приложения размещать в каталоге `src` а тесты в каталоге `tests`
- Например для класса `User` тестовый класс следует назвать `UserTest`, который будет отнаследован от `PHPUnit\Framework\TestCase`
- Внутри `UserTest` тестовые методы следует называть так, например `testLogin` или `testAdmin`
- Никогда не нужно ничего сохранять в тестах, они должны быть запущены независимо

### Утверждения

В тестах для проверки значений используются методы утверждения - assertions.
Таких методов [большое количество](https://phpunit.readthedocs.io/en/7.5/assertions.html)
Все они определены в классе `PHPUnit\Framework\TestCase`





Ассерты
В тестах никогда не нужно ничего сохранять, они должны запускаться независимо

Вывод тестов Какой тест не прошел, сообщение об ошибках , на какой строчке произошла ошибка

Тестировать нужно в сторону увеличения зависимостей

Лучше стараться ставить меньше проверок, если пытаться все проверять мы никогда не поймем что не так

Наборы данных DataSet

Тестирование исключений this->fail()

Фикстуры - для избегания дублирования кода


setUp до теста
TearDown после теста


Стабы Стаббинг замена одного обьекта на второй для теста
лучше заменять стабы на инверсию зависимоей

Моки почти всегда можно заменить на тестирование следсвий, нужно четко понимать стоит ли их использовать

Нужно за собой чистить, если что то существует то нужно удалить teardown

### Как тестировать

Для написания тестов к классу `Calculator` нужно создать тестовый класс в директории `/tests`,
к названию тестируемого класса добавить постфикс `Test` (`CalculatorTest`). 
Для того чтобы заработали "тестовые методы" нужно наследовать от класса фреймворка `PHPUnit\Framework\TestCase`
В классе нужно создать публичные методы с префиксом `test*`, например `testDevision()`, `testSumm()`,
так же при необходимости в аннотацию к методу можно добавить блок `@test`. 
Внутри тестовых методов для проверки фактических результатов с реальными используются утверждения например `assertEquals()`.
Запустить тест на выполнение можно командой `phpunit` (глобально) или `vendor/bin/phpunit` (локально для проекта) 

~~~php
class CalculatorTest extends TestCase
{}
~~~

Напишем простейший тест, где протестируем суммирование двух чисел

~~~php

public function testSumm()
{
    $object = new Calculator();
    $this->assertEquals($object->plus(1,2), 3, 'addition 1 + 2 is not true');
}
~~~

В большинстве утверждений можно указывать три параметра:
-   реальное значение
-   проверяемое значение
-   сообщение об ошибке, которое будет выведено в консоль при падении теста 

Результат будет примерно таким:

~~~bash
vendor/bin/phpunit CalculatorTest

PHPUnit 7.4.3 by Sebastian Bergmann and contributors.
.                                                                   1 / 1 (100%)
Time: 19 ms, Memory: 4.00MB
OK (1 test, 1 assertion)
~~~

Где отображаеться версия PHPUnit, статус теста, колличество выполненных тестов, время и память затраченная на выполнение тестов
В статусе теста могут быть следующие значения:

1. . тест пройден успешно
2. F тест сломался не прошло утверждение
3. E ошибка в коде при выполнении теста
4. R тест который без утверждения или с выводом из теста текста
5. S пропущенный тест
6. I не реализованный тест


Тесты могут быть зависимы друг от друга

~~~php
public function testOne()
{
    // какие-то вычисления
    $data = 7;
    $this->assertSame($data,7);
    return $data;
}

/**
 * @param $result
 * @depends testOne
 * @return int
 */
public function testTwo($result)
{
    $result2 = $result + 8;
    $this->assertEquals($result2, 15);
    return $result2;
}

/**
 * @param $result
 * @depends testTwo
 */
public function testThree($result)
{
    $result3 = $result - 10;
    $this->assertEquals($result3, 5);
}
~~~

С помощью аннотации `@depends`, phpUnit понимает очередность выполнения тестовых методов
Если зависимый тест провалился, то все последующие тесты будут пропущены

Предыдущие статьи:

1. [Тестирование кода. Идеология](http://lexusalex.ru/test-code-ideology)
2. Тестирование кода. Использование phpunit



[Страница с последними релизами phpunit](https://phar.phpunit.de/)




Удобно смотреть степень покрытия кода тестами
