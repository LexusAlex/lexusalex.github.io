---
layout: post
title: Linux. Хранение информации
permalink: linux-Information-storage
tags: linux unix
comments: true
subtitle: Linux. Хранение информации
summary:  Linux. Хранение информации
is_navigate: true
---

### Драйверы и файлы устройств в Linux

Каждому устройству в системе linux соотвествует специальный фаил этого устройства. 
Прикладные программы взаимодействуют с драйверами устройств через специальные фаилы этого устройства.
Драйвер устройства - это программа которая выполняет роль связующего между устройством и программой пользователя.

Управление устройством из программы пользователя осуществляется по следующей схеме.

1. Программа пользователя
2. Специальный фаил (указатель на драйвер)
3. Драйвер устройства (модуль программного кода ядра)
4. Ядро
5. Устройство

Такая схема обеспечивает единый подход к управлению устройствами через обычные файлы.

Устройства бывают :

1. Реальные. Устройства которые физически сущесвуют например жесткий диск, мышь, клавиатура.
2. Виртуальные.  Устройства которым не соответсвуют ни одно из подключенных аппаратных средств. 
Вместо этого ядро предоставяляет абстрактное устройство с таким же API как у реального

Файлы устройств подразделяют на два класса.

1. Блочные (b). Устройства передают данные блоками. Размер блока зависит от типа устройства, но обычно кратен 512 байт. Например жесткий диск.
2. Символьные (c). Устройства обрабатывают данные побайтно, например терминал, мышь.

### Каталог dev

Файлы устройств располагаются внутри файловой системы в каталоге `/dev`.

В ранних версиях linux этот каталог содержал все возможные типы устройств, их было буквально тысячи.
Проблему решили с помощью программы-менеджера `udev` которая опирается на виртуальную файловую систему `sysfs` (это файловая система находящиеся в памяти). 
Благодаря `udev` сейчас в каталоге находятся только те файлы тех устройств которые в настоящий момент подключены к системе.

При отключении устройства фаил удаляется. 
Соотвественно при каждом запуске системы файлы устройств создаются заново.

TODO `udev on /dev type devtmpfs (rw,nosuid,relatime,size=994260k,nr_inodes=248565,mode=755)`

### Номер устройства

Каждое устройство имеет свои номера (идентификаторы)

1. Старший идентификатор (Major) - общий класс или устройства, используется для поиска драйвера. 
Список старших идентификаторов которые известны ядру можно вывести выполнив команду `cat /proc/devices`
2. Младший идентификатор (Minor) - номер уникально идентифицирующий устройство внутри класса.

Посмотреть старшие и младшие идентификаторы а так же типы различных устройств в настоящее время подключенных к системе можно заглянув в каталог dev

```bash
ls -l /dev/sd* /dev/input/mouse* /dev/snd/pcm*
crw-rw---- 1 root input  13, 32 апр  6 09:42 /dev/input/mouse0
crw-rw---- 1 root input  13, 33 апр  6 09:42 /dev/input/mouse1
crw-rw---- 1 root input  13, 34 апр  6 09:42 /dev/input/mouse2
brw-rw---- 1 root disk    8,  0 апр  6 09:42 /dev/sda
brw-rw---- 1 root disk    8,  1 апр  6 09:42 /dev/sda1
brw-rw---- 1 root disk    8, 16 апр  6 09:42 /dev/sdb
brw-rw---- 1 root disk    8, 32 апр  6 09:42 /dev/sdc
crw-rw---- 1 root audio 116,  3 апр  6 09:42 /dev/snd/pcmC0D0c
crw-rw---- 1 root audio 116,  2 апр  6 09:42 /dev/snd/pcmC0D0p
crw-rw---- 1 root audio 116,  4 апр  6 09:42 /dev/snd/pcmC0D1p
```
Где первый символ это тип устройства символьное (с) или блочное (b)

```bash
file /dev/input/mouse0
/dev/input/mouse0: character special (13/32)

file /dev/sda
/dev/sda: block special (8/0)
```
А числа через запятую это и есть номера устройства.

>> В ранних версиях linux количество подключенных устройств к системе было ограничено, тем самым что номера описаны 8 битами.
>В современных версиях linux это ограничение стало менее строгим за счет увеличения кол-ва битов для хранения номеров (12 и 20 бит) 

Номера устройств также удобно смотреть командой `lsblk`

```bash
lsblk
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda      8:0    0    5G  0 disk 
└─sda1   8:1    0    5G  0 part /
sdb      8:16   0    2G  0 disk 
sdc      8:32   0    2G  0 disk 
sr0     11:0    1  335M  0 rom 
```

Права на устройства устанавливаются путем добавления соотвествующих групп пользователям.

Теперь переходим конкректно к дисковым устройствам

### Нумерация жеских дисков

>> Ранее диски именовались в зависимости от типа их интерфейса и могли иметь имена hd*, vd*, сейчас все зависимости
>от типа интерфеса они все имеют название sd*

Каждому подключенному жесткому диску присваеватся буква латинского алфавита

```bash
ls -1 /dev/sd*
/dev/sda
/dev/sda1
/dev/sdb
/dev/sdc
/dev/sdd
/dev/sde
/dev/sdf
/dev/sdg
/dev/sdh
```
Порядок присвоение букв дисков определен в порядке подключения к дисковому контроллеру сначала внутренние SATA, потом все внешние USB

### Таблица разделов / Загрузка ОС

Все компьютеры независимо от операционной системы при загрузке могут использовать два метода структур разделов

1. BIOS-MBR - Master Boot Record
2. UEFI-GPT - GUID Partition Table

До того как BIOS определит загрузочное устройство, происходит инициализация различных устройств и тестирование системы.

#### MBR

Как только было определено загрузочное устройство, будет считан первый сектор этого устройства в память.
Первый сектор диска это 512 байт.

MBR содержит :

1. Первая стадия загрузчика
2. Таблица разделов диска (1 раздел = 16 байт) - всего 4 раздела (64 байта)
3. Подпись диска

Прочтем содержимое MBR, сделаем его дамп

```bash
sudo dd if=/dev/sda of=/tmp/mbr.bin bs=512 count=1
```
Проверим тип файла
```bash
file -k /tmp/mbr.bin
/tmp/mbr.bin: DOS/MBR boot sector DOS/MBR boot sector DOS executable (COM), boot code\012- data
```
Просмотреть дамп можно командой `sudo hexdump  -C /tmp/mbr.bin | less`

Далее загружается вторая стадия загрузчика. 
Она получает список операционны систем на жестких дисках и предоставляет возможность выбора.

Итак MBR 

1. Каждый раздел ограничен максимальным размеров в 2ТБ
2. Допускает только четыре раздела
3. Информация о разделе хранится в главной загрузочной записи, при его повреждении диск становится нечитаемым

#### GPT

1. Современный вариант разметки, поддерживает до 128 разделов
2. Для определения структуры используются глобальные уникальные идентификаторы GUID
3. Ограничение на размер раздела 9,4 ЗБ
4. GPT хранит копию загрузочных данных, есть возможность их восстановить

### Раздел диска

https://www.alv.me/Nakopiteli-v-linux-modeli-imenovaniya/

### Сектор / Блок

### Индексный дескриптор

### Файловая система

Находиться внутри тома

### Дерево каталогов

### Монтирование



Файловая система
Внешний носитель iso 9660 CDFS NFS - сетевая файловая система
Дерево каталогов - для обеспечения доступа к информации, единая структура
Псевдофайловая система
Корневая фс
Монтирование

blockdev 
udev
https://itsecforu.ru/2018/11/26/%D0%BA%D0%B0%D0%BA-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D1%8C-udev-%D0%B4%D0%BB%D1%8F-%D0%BE%D0%B1%D0%BD%D0%B0%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B8-%D1%83/
sysfs
http://mydebianblog.blogspot.com/2013/02/sysfs-linux.html

https://debianinstall.ru/tipy-fajlov-linux/
https://habr.com/ru/company/flant/blog/354802/
https://linux-notes.org/kak-ispol-zovat-komandu-fdisk-na-linux/
https://4admin.info/linux-superblock/
https://habr.com/ru/company/otus/blog/446614/

https://habr.com/ru/post/462849/



