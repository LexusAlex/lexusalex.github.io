--- 
layout: post 
title: Идеология docker. part 0
permalink: docker-ideology
tags: docker linux
comments: true
---

На протяжении всего этого года для разработки стал переводить проекты в [docker](https:/docker.com/).

### Технологии виртуализации

Несколько определений:

- Хостовая операционная система - это система на которой работает технология виртуализации
- Гостевая операционная система - системма запущенная внутри хостовой ОС
- Гипервизор - ПО, для запуска гостевых операционных систем

Самое важно здесь, что гипервизор может работать на уровне железа и на уровне хостовой операционной системы (VMware, VirtualBox),
тем самым забирая ресурсы у хостовой ОС.

Docker использует контейнерную вирутализацию. Ядро операционной системы позволяет запускать множество изолированных
экземляров пользовательских пространств имен ядра. Пространиство имен называют контейнером.
Таким образом можно запустить множество независимых контейнеров на одной операционной системе

Важно понимать что технология контейнеров доступна только в опрационной системе Linux

Docker – это открытая платформа, предназначенная для разработки, доставки и организации работы приложений. 

Docker позволяет быстро запустить приложение в изолированной среде, то есть в контейнере.

### Ядро Docker

Docker Engine состоит из следующих компонентов:

- Сервер - процесс демон dockerd

    - Образы
    - Контейнеры
    - Тома данных
    - Сети
- REST API - интерфейсы для взаимодействия через unix сокеты или сетевые интерфейсы
- Cli - консольный клиент

Клиент Docker взаимодействует с демоном при помощи REST API

Установка для всех операционных систем подробно разобрана на [официальном сайте](https://docs.docker.com/install/)

### Контейнеры и образы

Образ - это готовая файловая система с набором программ, которые распространяются через реестры образов.
Реестр образов находятся на сайте [https://hub.docker.com/](https://hub.docker.com/). Там же находяться инструкции для запуска контейнера

Образ создается на основе файловой системы, например:

- [scratch](https://hub.docker.com/_/scratch) - пустая файловая система
- [busybox](https://hub.docker.com/_/busybox) - набор утилит командной строки
- [alpine](https://hub.docker.com/_/alpine) - минималистичный дистрибутив linux

Например образ `ubuntu` создается на основе `scratch`

Для того чтобы создать свой образ на основе другого образа нужно использовать специальный фаил `Dockerfile`, c набором
инструкций

~~~dockerfile
FROM scratch
ADD rootfs.tar.xz /
CMD ["/bin/sh"]
~~~
Где каждая команда создает новый слой(уровень) в образе, результат выполнения этих команд кешируется для дальнейшего переиспользования.

Набор слоев можно посмотреть командой `docker history image`

~~~bash
docker history alpine:3.8

IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT
196d12cf6ab1        3 months ago        /bin/sh -c #(nop)  CMD ["/bin/sh"]              0B                  
<missing>           3 months ago        /bin/sh -c #(nop) ADD file:25c10b1d1b41d46a1…   4.41MB  
~~~

Контейнер это просто запущенный экземпляр образа. Контейнер можно запустить, удалить, остановить.

Какие преимущества у контейнеров:
1. легкость к переносу и развертыванию контейнеров на другой системе
2. изолированная работа контейнера от основной операционной системы
3. можно запускать много контейнеров на одной системе, что позволяет имитировать реальную промышленную среду
4. легко соединить среду исполнения и среду разработки, что решает головную боль с конфигурированием
5. имеют собственное сетевое окружение

Докер позволяет упаковать приложение в контейнер со всеми зависимостями, нужно средой исполнения, сделать его переносимым
и самодостаточным.

В реальном проекте любая составляющая часть системы может быть заменена.

Для работы типичного приложения требуется:

- операционная система
- веб-сервер
- база данных
- другой сервис

С докером можно выбрать именно тот софт, с помощью которого будет работать реальное приложение. 
Например возьмем такой софт:
- debian 9 apache 2.4.37 php 7.3
- ubuntu 18.04 mysql 8
- alpine 3.8 memcached 1.5

Собираем и запускаем полностью, независимых друг от друга, три контейнера. Благодаря такой архитектуре можно менять
любую часть системы, как это требуется. При этом нет никакого захламления хостовой системы, контейнеры так же быстро
создать, так и уничтожить.

### Запуск несколько контейнеров одновременно

Ну с одним контейнером все более менее просто, а что делать если их становиться больше одного, как ими всеми управлять.

Для этого случая существует такой инструмент, как [docker-compose](https://docs.docker.com/compose/) он позволяет конфигурировать и запускать
сразу несколько контейнеров (сервисов), что позволяет менять зависимости так как это нужно.

Пример конфигурационного файла `docker-compose.yml`

~~~yaml
version: '3.3'

services:
   db:
     image: mysql:5.7
     volumes:
       - db_data:/var/lib/mysql
     restart: always
     environment:
       MYSQL_ROOT_PASSWORD: somewordpress
       MYSQL_DATABASE: wordpress
       MYSQL_USER: wordpress
       MYSQL_PASSWORD: wordpress

   wordpress:
     depends_on:
       - db
     image: wordpress:latest
     ports:
       - "8000:80"
     restart: always
     environment:
       WORDPRESS_DB_HOST: db:3306
       WORDPRESS_DB_USER: wordpress
       WORDPRESS_DB_PASSWORD: wordpress
volumes:
    db_data: {}
~~~

В итоге собрать, создать и запустить сразу все приложение можно командой `docker-compose up -d`

### Ссылки

1. [docker](https:/docker.com/) - проект docker
1. [docker-compose](https://docs.docker.com/compose/) - проект docker-compose
1. [https://hub.docker.com/](https://hub.docker.com/) - реестр образов
1. [https://docs.docker.com/](https://docs.docker.com/) - документация
1. [phpearth](https://github.com/phpearth/docker-php) - репозиторий образов phpearth
1. [cgroups](https://ru.wikipedia.org/wiki/Cgroups) - механизм ограничения ресурсов центрального процессора
1. [namespaces](https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D1%81%D1%82%D1%80%D0%B0%D0%BD%D1%81%D1%82%D0%B2%D0%BE_%D0%B8%D0%BC%D1%91%D0%BD_(Linux)) - пространство имен linux


UPD 19.01.2019 обновил статью





   


 



 